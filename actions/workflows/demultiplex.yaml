
# Demultiplexing
# ==============
# Setups up a runfolder for demultiplexing assuming that the samplesheet
# needs to be copied from `samplesheet_location` into the runfolder.
# Then starts bcl2fastq and waits until it's done.
#

version: "2.0" # mistral version

arteria-packs.demultiplex:

    type: direct
    input:
        - host
        - bcl2fastq_service_port
        - runfolder_name
        - samplesheet_location
        - bcl2fastq_version
        - barcode_mismatches
        - tiles
        - use_base_mask
        - bcl2fastq_additional_arguments

    tasks:

        # TODO This should be pulled from the
        #      Hermes sever instead in the future.
#        download_samplesheet:
#            action: arteria-packs.copy_samplesheet
#            input:
#                runfolder: <% $.runfolder %>
#                samplesheet_location: <% $.samplesheet_location %>
#                username: <% $.username %>
#                password: <% $.password %>
#                hosts: <% $.host %>
#            on-success:
#                - construct_bcl2fastq_body

        # Since we don't want to pass empty values into
        # bcl2fastq-ws, we remove any empty keys from
        # this body.
        construct_bcl2fastq_body:
            action: arteria-packs.parse_bcl2fastq_args
            input:
                bcl2fastq_version: "<% $.bcl2fastq_version %>"
                barcode_mismatches: "<% $.barcode_mismatches %>"
                tiles: "<% $.tiles %>"
                use_base_mask: "<% $.use_base_mask %>"
                additional_arguments: "<% $.bcl2fastq_additional_arguments %>"
            publish:
                bcl2fastq_body: <% $.construct_bcl2fastq_body.stdout %>
            on-success:
                - run_bcl2fastq

        run_bcl2fastq:
            action: core.http
            input:
                url: "http://<% $.host %>:<% $.bcl2fastq_service_port %>/api/1.0/start/<% $.runfolder_name %>"
                method: "POST"
                headers: "Content-Type=application/json"
                body: <% $.bcl2fastq_body %>
            publish:
                bcl2fastq_status_code: <% $.run_bcl2fastq.status_code %>
                bcl2fastq_status_url: <% $.run_bcl2fastq.body.link %>
            on-success:
                - poll_status

        poll_status:
            action: arteria-packs.poll_status
            input:
                url: <% $.bcl2fastq_status_url %>
            publish:
                poll_out: <% $.poll_status.stdout %>
                poll_err: <% $.poll_status.stderr %>
                qc_err: <% $.poll_status.stdout %> <% $.poll_status.stderr %>
