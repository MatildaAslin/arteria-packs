version: "2.0" # mistral version
name: arteria-packs.archive_set_removable
description: Mark an archive as removable in the db.

workflows:
    main:
        type: direct
        input:
            - description
        output:
            output_the_whole_workflow_context: <% $ %>
        task-defaults:
          on-error:
            - notify_failure_on_slack

        tasks:
            ### GENERAL TASKS START ###
            note_workflow_repo_version:
              action: core.local
              input:
                cmd: git rev-parse HEAD
                cwd: /opt/stackstorm/packs/arteria-packs/
              on-success:
                - get_config

            get_config:
              action: arteria-packs.get_pack_config
              publish:
#                archive_remove_port: <% task(get_config).result.result.archive_remove_service_port %>
#                archive_remove_base_url: <% task(get_config).result.result.archive_remove_base_url %>
                archive_status_slack_channel: <% task(get_config).result.result.archive_status_slack_channel %>
                archive_db_base_url: <% task(get_config).result.result.archive_db_base_url %>
              on-success:
                - mark_as_removable_in_db

            ### GENERAL TASKS END ###

            ### TSM ARCHIVE MARK REMOVABLE START ###

            mark_as_removable_in_db:
                action: core.http
                input:
                  url: <% $.archive_db_base_url %>/removal
                  body: '{ "description": "<% $.description %>", "action": "set_removable" }'
                  method: "POST"
                  timeout: 30
                publish:
                  archive_name: <% task(mark_as_removable_in_db).result.body.archive.path %>
                  archive_host: <% task(mark_as_removable_in_db).result.body.archive.host %>
                  archive_description: <% task(mark_as_removable_in_db).result.body.archive.description %>
                on-success:
                  - notify_success_on_slack

            notify_success_on_slack:
              action: arteria-packs.post_to_slack
              input:
                user: "I, Archivian"
                emoji_icon: ":robot_face:"
                channel: <% $.archive_status_slack_channel %>
                message: "I have now scheduled archive `<% $.archive_path %>`, with description `<% $.archive_description %>,` on `<% $.archive_host %>` for removal. See details with `st2 execution get <% env().st2_execution_id %>`"

            ### END TSM ARCHIVE MARK REMOVABLE ###

            ## NOTIFIER START ###

            notify_failure_on_slack:
               action: arteria-packs.post_to_slack
               input:
                 user: 'I, Archivian'
                 emoji_icon: ':robot_face:'
                 channel: <% $.archive_status_slack_channel %>
                 message: 'Unfortunately an error occurred when trying to mark the archive with description `<% $.description %>` for removal. You can see more details by running: `st2 execution get <% env().st2_execution_id %>`'
               on-complete:
                 - fail

            ### NOTIFIER END ###
