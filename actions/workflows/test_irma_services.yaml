version: "2.0" # mistral version
name: arteria-packs.test_irma_services
description: Testing

workflows:
    main:
        type: direct
        input:
            - runfolder_name

        tasks:

            get_config:
              action: arteria-packs.get_pack_config
              publish:
                hermes_base_url: <% task(get_config).result.result.hermes_base_url %>
                hermes_user: <% task(get_config).result.result.hermes_user %>
                hermes_token: <% task(get_config).result.result.hermes_token %>
                remote_host: <% task(get_config).result.result.remote_host %>
                remote_user: <% task(get_config).result.result.remote_user%>
                remote_destination: <% task(get_config).result.result.remote_destination %>
                summary_host: <% task(get_config).result.result.summary_host %>
                summary_user: <% task(get_config).result.result.summary_user %>
                summary_destination: <% task(get_config).result.result.summary_destination %>
                siswrap_service_port: <% task(get_config).result.result.siswrap_service_port %>
                bcl2fastq_service_port: <% task(get_config).result.result.bcl2fastq_service_port %>
                runfolder_service_port: <% task(get_config).result.result.runfolder_service_port %>
                send_mail_to: <% task(get_config).result.result.send_mail_to %>
                remote_sisyphus_location: <% task(get_config).result.result.remote_sisyphus_location %>
                nestor_remote_path: <% task(get_config).result.result.nestor_remote_path %>
                irma_remote_path: <% task(get_config).result.result.irma_remote_path %>
                irma_api_key: <% task(get_config).result.result.irma_api_key %>
                irma_checksum_base_url: <% task(get_config).result.result.irma_checksum_base_url %>
                irma_siswrap_base_url: <% task(get_config).result.result.irma_siswrap_base_url %>
                ngi_pipeline_url: <% task(get_config).result.result.ngi_pipeline_url %>
                irma_replace_expressions: <% task(get_config).result.result.irma_replace_expressions %>
              on-success:
                 - irma_check_md5sums

            irma_check_md5sums:
               action: core.http
               input:
                    method: "POST"
                    url: <% $.irma_checksum_base_url %>/start/<% $.runfolder_name %>?apikey=<% $.irma_api_key %>
                    body: '{"path_to_md5_sum_file": "MD5/checksums.md5"}'
                    verify_ssl_cert: False
               publish:
                 md5sum_job_id: <% task(irma_check_md5sums).result.body.job_id %>
               on-success:
                 - poll_irma_check_md5sums

            poll_irma_check_md5sums:
                action: arteria-packs.poll_status
                input:
                  url: <% $.irma_checksum_base_url %>/status/<% $.md5sum_job_id %>?apikey=<% $.irma_api_key %>
                  skip_cert: True
                on-success:
                  - irma_run_aeacus_stats
            
            ### TRANSFER FILES TO UPPMAX END ###

            ### START AEACUS REPORT STEPS ###
            irma_run_aeacus_stats:
               action: core.http
               input:
                    method: "POST"
                    url: <% $.irma_siswrap_base_url %>/aeacusstats/run/<% $.runfolder_name %>?apikey=<% $.irma_api_key %>
                    body: '{"runfolder": "<% $.runfolder_name %>"}'
                    verify_ssl_cert: False
               publish:
                   irma_run_aeacus_stats_job_id: <% task(irma_run_aeacus_stats).result.body.pid %>
               on-success:
                 - poll_irma_aeacus_stats

            poll_irma_aeacus_stats:
               action: arteria-packs.poll_status
               input:
                  url: <% $.irma_siswrap_base_url %>/aeacusstats/status/<% $.irma_run_aeacus_stats_job_id %>?apikey=<% $.irma_api_key %>
                  skip_cert: True
               on-success:
                 - irma_run_aeacus_reports

            irma_run_aeacus_reports:
               action: core.http
               input:
                  method: "POST"
                  url: <% $.irma_siswrap_base_url %>/aeacusreports/run/<% $.runfolder_name %>?apikey=<% $.irma_api_key %>
                  body: '{"runfolder": "<% $.runfolder_name %>"}'
                  verify_ssl_cert: False
               publish:
                 irma_run_aeacus_reports_job_id: <% task(irma_run_aeacus_reports).result.body.pid %>
               on-success:
                 - poll_irma_aeacus_reports

            poll_irma_aeacus_reports:
                action: arteria-packs.poll_status
                input:
                  url: <% $.irma_siswrap_base_url %>/aeacusreports/status/<% $.irma_run_aeacus_reports_job_id %>?apikey=<% $.irma_api_key %>
                  skip_cert: True
                    

